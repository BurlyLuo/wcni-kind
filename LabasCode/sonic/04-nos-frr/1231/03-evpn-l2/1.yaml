name: evpn
prefix: "l3"

topology:
  nodes:
    leaf1:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/leaf1.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        - modprobe 8021q
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1

        # add vtep ip
        - ip addr add 100.64.0.1/32 dev lo
         
        # leaf1 to spine
        - ip addr add 192.168.1.1/24 dev eth1
         
        # add vrf[spec vrf]
        - ip link add red type vrf table 1100
        - ip link set red up

        # For subnet 10.1.5.0/24
        # add vxlan5000 and bridge br5
        - ip link add vxlan5000 type vxlan local 100.64.0.1 dstport 4789 external vnifilter nolearning
        - ip link add br5 type bridge vlan_filtering 1 vlan_default_pvid 0 vlan_stats_enabled 1 vlan_stats_per_port 1
        - ip link set br5 up
        - ip link set br5 master red
        - ip link set br5 addr aa:bb:cc:05:01:05

        # add vxlan5000 to bridge br5
        - ip link set vxlan5000 master br5
        - ip link set vxlan5000 type bridge_slave vlan_tunnel on neigh_suppress on learning off
        - ip link set vxlan5000 up

        # config vlan 5 to vni 5000 mapping
        - bridge vlan add dev br5 vid 5 self
        - bridge vlan add dev vxlan5000 vid 5
        - bridge vni add dev vxlan5000 vni 5000
        - bridge vlan add dev vxlan5000 vid 5 tunnel_info id 5000

        # config leaf1 to host with vlan 5
        - ip link set eth2 master br5
        - bridge vlan add dev eth2 vid 5 master

    leaf2:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/leaf2.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        - modprobe 8021q
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1

        # add vtep ip 
        - ip addr add 100.65.0.2/32 dev lo

        # leaf2 to spine
        - ip addr add 192.168.1.3/24 dev eth1

        # add vrf[spec vrf] 
        - ip link add red type vrf table 1100
        - ip link set red up

        # For subnet 10.1.5.0/24 
        - ip link add vxlan5000 type vxlan local 100.65.0.2 dstport 4789 external vnifilter nolearning
        - ip link add br5 type bridge vlan_filtering 1 vlan_default_pvid 0 vlan_stats_enabled 1 vlan_stats_per_port 1
        - ip link set br5 master red
        - ip link set br5 addr aa:bb:cc:05:02:05
        - ip link set br5 up

        - ip link set vxlan5000 master br5
        - ip link set vxlan5000 type bridge_slave vlan_tunnel on neigh_suppress on learning off
        - ip link set vxlan5000 up
 
        # config vlan 5 to vni 5000 mapping
        - bridge vlan add dev br5 vid 5 self
        - bridge vlan add dev vxlan5000 vid 5
        - bridge vni add dev vxlan5000 vni 5000
        - bridge vlan add dev vxlan5000 vid 5 tunnel_info id 5000

        - ip link set eth2 master br5
        - bridge vlan add dev eth2 vid 5 master

    spine:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/spine.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        # spine to leaf1 and leaf2
        - ip addr add 192.168.1.0/31 dev eth1
        - ip addr add 192.168.1.2/31 dev eth2

    vm1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.5 type vlan id 5
        - ip addr add 10.1.5.10/24 dev eth1.5
        - ip link set eth1.5 up
        - ip link set dev eth1 address 52:54:10:01:05:10

    vm2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.5 type vlan id 5
        - ip addr add 10.1.5.11/24 dev eth1.5
        - ip link set eth1.5 up
        - ip link set dev eth1 address 52:54:10:01:05:11

  links:
    # spine <> leaf1
    # 192.168.1.0/31 <> 192.168.1.1/31
    - endpoints: ["spine:eth1", "leaf1:eth1"]
    # spine <> leaf2
    # 192.168.1.2/31 <> 192.168.1.3/31
    - endpoints: ["spine:eth2", "leaf2:eth1"]
   
    # leaf1 <> 10.1.5.10/24
    - endpoints: ["leaf1:eth2", "vm1:eth1"]
    # leaf2 <> 10.1.5.11/24
    - endpoints: ["leaf2:eth2", "vm2:eth1"]
