name: evpn
prefix: ""

topology:
  nodes:
    r1:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/frr.conf.r1:/etc/frr/frr.conf
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1
        - touch /etc/frr/vtysh.conf
        # Underlay网络 (eth1)
        - ip addr add 192.168.100.1/24 dev eth1
        - ip link set eth1 up
        # VXLAN隧道
        - ip link add vxlan100 type vxlan dstport 4789 local 192.168.100.1 external vnifilter nolearning
        - ip link add br100 type bridge vlan_filtering 1 vlan_stats_enabled 1 vlan_stats_per_port 1
        - ip link set vxlan100 master br100
        - ip link set vxlan100 type bridge_slave vlan_tunnel on neigh_suppress on learning off
        - ip link set br100 addr aa:bb:cc:00:00:01
        - ip link set br100 up
        - ip link set vxlan100 up
        # 关键: 将物理接口加入桥接 (保持tagged)
        - ip link set eth2 master br100
        - ip link set eth3 master br100
        # VLAN 5 → VNI 5000 (10.1.5.0/24)
        - ip link add v5.5000 link br100 type vlan id 5
        - bridge vlan add vid 5 dev br100 self
        - ip link set v5.5000 up
        - ip addr add 10.1.5.254/24 dev v5.5000
        - bridge vni add dev vxlan100 vni 5000
        # 正确的tunnel_info语法
        - bridge vlan add dev vxlan100 vid 5 master
        - bridge vlan add dev vxlan100 vid 5 tunnel_info id 5000 master
        # 修正: 接受VLAN 5 tagged包 (移除pvid untagged)
        - bridge vlan add dev eth2 vid 5 master
        # VLAN 8 → VNI 8000 (10.1.8.0/24)
        - ip link add v8.8000 link br100 type vlan id 8
        - bridge vlan add vid 8 dev br100 self
        - ip link set v8.8000 up
        - ip addr add 10.1.8.254/24 dev v8.8000
        - bridge vni add dev vxlan100 vni 8000
        # 正确的tunnel_info语法
        - bridge vlan add dev vxlan100 vid 8 master
        - bridge vlan add dev vxlan100 vid 8 tunnel_info id 8000 master
        # 修正: 接受VLAN 8 tagged包 (移除pvid untagged)
        - bridge vlan add dev eth3 vid 8 master

    r2:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/frr.conf.r2:/etc/frr/frr.conf
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1
        - touch /etc/frr/vtysh.conf
        # Underlay网络 (eth1)
        - ip addr add 192.168.100.2/24 dev eth1
        - ip link set eth1 up
        # VXLAN隧道
        - ip link add vxlan100 type vxlan dstport 4789 local 192.168.100.2 external vnifilter nolearning
        - ip link add br100 type bridge vlan_filtering 1 vlan_stats_enabled 1 vlan_stats_per_port 1
        - ip link set vxlan100 master br100
        - ip link set vxlan100 type bridge_slave vlan_tunnel on neigh_suppress on learning off
        - ip link set br100 addr aa:bb:cc:00:00:02
        - ip link set br100 up
        - ip link set vxlan100 up
        # 关键: 将物理接口加入桥接 (保持tagged)
        - ip link set eth2 master br100
        - ip link set eth3 master br100
        # VLAN 5 → VNI 5000 (10.1.5.0/24)
        - ip link add v5.5000 link br100 type vlan id 5
        - bridge vlan add vid 5 dev br100 self
        - ip link set v5.5000 up
        - ip addr add 10.1.5.254/24 dev v5.5000
        - bridge vni add dev vxlan100 vni 5000
        # 正确的tunnel_info语法
        - bridge vlan add dev vxlan100 vid 5 master
        - bridge vlan add dev vxlan100 vid 5 tunnel_info id 5000 master
        # 修正: 接受VLAN 5 tagged包
        - bridge vlan add dev eth2 vid 5 master
        # VLAN 8 → VNI 8000 (10.1.8.0/24)
        - ip link add v8.8000 link br100 type vlan id 8
        - bridge vlan add vid 8 dev br100 self
        - ip link set v8.8000 up
        - ip addr add 10.1.8.254/24 dev v8.8000
        - bridge vni add dev vxlan100 vni 8000
        # 正确的tunnel_info语法
        - bridge vlan add dev vxlan100 vid 8 master
        - bridge vlan add dev vxlan100 vid 8 tunnel_info id 8000 master
        # 修正: 接受VLAN 8 tagged包
        - bridge vlan add dev eth3 vid 8 master

    h1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        # 保持VLAN tagging (完全符合您的要求)
        - ip link add link eth1 name eth1.5 type vlan id 5
        - ip link set eth1.5 up
        - ip addr add 10.1.5.10/24 dev eth1.5
        - ip link set dev eth1.5 address 52:54:10:01:05:10
        - ip r r default via 10.1.5.254 dev eth1.5

    h2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.8 type vlan id 8
        - ip link set eth1.8 up
        - ip addr add 10.1.8.10/24 dev eth1.8
        - ip link set dev eth1.8 address 52:54:10:01:08:10
        - ip r r default via 10.1.8.254 dev eth1.8

    h3:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.5 type vlan id 5
        - ip link set eth1.5 up
        - ip addr add 10.1.5.11/24 dev eth1.5
        - ip link set dev eth1.5 address 52:54:10:01:05:11
        - ip r r default via 10.1.5.254 dev eth1.5

    h4:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.8 type vlan id 8
        - ip link set eth1.8 up
        - ip addr add 10.1.8.11/24 dev eth1.8
        - ip link set dev eth1.8 address 52:54:10:01:08:11
        - ip r r default via 10.1.8.254 dev eth1.8

  links:
    # Underlay网络
    - endpoints: ["r1:eth1", "r2:eth1"]
    # r1 业务网络
    - endpoints: ["r1:eth2", "h1:eth1"]
    - endpoints: ["r1:eth3", "h2:eth1"]
    # r2 业务网络
    - endpoints: ["r2:eth2", "h3:eth1"]
    - endpoints: ["r2:eth3", "h4:eth1"]
