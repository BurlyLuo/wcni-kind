name: evpn
prefix: ""

topology:
  nodes:
    leaf1:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/leaf1.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf

        # add vtep ip
        - ip addr add 100.64.0.1/32 dev lo
         
        # leaf1 to spine
        - ip addr add 192.168.1.1/24 dev eth1
         
        # add vrf[spec vrf]
        - ip link add red type vrf table 1100
        - ip link set red up

        # For subnet 10.1.5.0/24
        - ip link add br5 type bridge
        - ip link set br5 master red
        - ip link set br5 addr aa:bb:cc:05:01:05
        - ip link add vni5000 type vxlan local 100.64.0.1 dstport 4789 id 5000 nolearning
        - ip link set vni5000 master br5 addrgenmode none
        - ip link set vni5000 type bridge_slave neigh_suppress on learning off
        - ip link set br5 up
        - ip link set vni5000 up
        - ip addr add 10.1.5.254/24 dev br5

        # For subnet 10.1.8.0/24
        - ip link add br8 type bridge
        - ip link set br8 master red
        - ip link set br8 addr aa:bb:cc:08:01:08
        - ip link add vni8000 type vxlan local 100.64.0.1 dstport 4789 id 8000 nolearning
        - ip link set vni8000 master br8 addrgenmode none
        - ip link set vni8000 type bridge_slave neigh_suppress on learning off
        - ip link set br8 up
        - ip link set vni8000 up
        - ip addr add 10.1.8.254/24 dev br8

        # For subnet 10.1.9.0/24 and 10.1.10.0/24
        - ip link add br100 type bridge
        - ip link set br100 master red addrgenmode none
        - ip link set br100 addr aa:bb:cc:09:01:09
        - ip link add vni100 type vxlan local 100.64.0.1 dstport 4789 id 100 nolearning
        - ip link set vni100 master br100 addrgenmode none
        - ip link set vni100 type bridge_slave neigh_suppress on learning off
        - ip link set vni100 up
        - ip link set br100 up
        
        # For leaf1 to vm:10.1.5.x and vm:10.1.8.x and vm:10.1.9.x
        - ip link set eth2 master br5
        - ip link set eth3 master br8
        - ip link set eth4 master red
        - ip addr add 10.1.9.254/24 dev eth4


    leaf2:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/leaf2.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf

        # add vtep ip 
        - ip addr add 100.65.0.2/32 dev lo

        # leaf2 to spine
        - ip addr add 192.168.1.3/24 dev eth1

        # add vrf[spec vrf] 
        - ip link add red type vrf table 1100
        - ip link set red up

        # For subnet 10.1.5.0/24 
        - ip link add br5 type bridge
        - ip link set br5 master red
        - ip link set br5 addr aa:bb:cc:05:02:05
        - ip addr add 10.1.5.254/24 dev br5
        - ip link add vni5000 type vxlan local 100.65.0.2 dstport 4789 id 5000 nolearning
        - ip link set vni5000 master br5 addrgenmode none
        - ip link set vni5000 type bridge_slave neigh_suppress on learning off
        - ip link set vni5000 up
        - ip link set br5 up

        # For subnet 10.1.8.0/24
        - ip link add br8 type bridge
        - ip link set br8 master red
        - ip link set br8 addr aa:bb:cc:08:02:08
        - ip addr add 10.1.8.254/24 dev br8
        - ip link add vni8000 type vxlan local 100.65.0.2 dstport 4789 id 8000 nolearning
        - ip link set vni8000 master br8 addrgenmode none
        - ip link set vni8000 type bridge_slave neigh_suppress on learning off
        - ip link set vni8000 up
        - ip link set br8 up

        # For subnet 10.1.9.0/24 and 10.1.10.0/24
        - ip link add br100 type bridge
        - ip link set br100 master red addrgenmode none
        - ip link set br100 addr aa:bb:cc:09:02:09
        - ip link add vni100 type vxlan local 100.65.0.2 dstport 4789 id 100 nolearning
        - ip link set vni100 master br100 addrgenmode none
        - ip link set vni100 type bridge_slave neigh_suppress on learning off
        - ip link set vni100 up
        - ip link set br100 up
        
        - ip link set eth2 master br5
        - ip link set eth3 master br8
        - ip link set eth4 master red
        - ip addr add 10.1.10.254/24 dev eth4

    spine:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/spine.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        # spine to leaf1 and leaf2
        - ip addr add 192.168.1.0/31 dev eth1
        - ip addr add 192.168.1.2/31 dev eth2

    vm1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.5.10/24 dev eth1
        - ip r r default via 10.1.5.254

    vm2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.8.10/24 dev eth1
        - ip r r default via 10.1.8.254

    vm3:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.5.11/24 dev eth1
        - ip r r default via 10.1.5.254

    vm4:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.8.11/24 dev eth1
        - ip r r default via 10.1.8.254

    vm5:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.9.10/24 dev eth1
        - ip r r default via 10.1.9.254

    vm6:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.10.10/24 dev eth1
        - ip r r default via 10.1.10.254

  links:
    # 192.168.1.0/31 <> 192.168.1.1/31
    - endpoints: ["spine:eth1", "leaf1:eth1"]
    # 192.168.1.2/31 <> 192.168.1.3/31
    - endpoints: ["spine:eth2", "leaf2:eth1"]
   
    # 10.1.5.10/24 <> 10.1.5.11/24
    - endpoints: ["leaf1:eth2", "vm1:eth1"]
    - endpoints: ["leaf2:eth2", "vm3:eth1"]
    # 10.1.8.10/24 <> 10.1.8.11/24
    - endpoints: ["leaf1:eth3", "vm2:eth1"]
    - endpoints: ["leaf2:eth3", "vm4:eth1"]

    # 10.1.9.10/24 <> 10.1.10.10/24
    - endpoints: ["leaf1:eth4", "vm5:eth1"]
    - endpoints: ["leaf2:eth4", "vm6:eth1"]
