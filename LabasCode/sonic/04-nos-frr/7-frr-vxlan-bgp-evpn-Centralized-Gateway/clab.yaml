name: vs
topology:
  nodes:
    frrbr:
      kind: bridge
   
    spine1:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/g' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./startup-conf/spine1.conf:/etc/frr/frr.conf
      exec:
        - touch /etc/frr/vtysh.conf
        - bash -c "echo 'PS1=\"[\\u@\\h]\\$ \"' > /root/.bashrc"
        - ip a a 1.1.1.10/24 dev eth1
        # Configure VXLAN interfaces and bridges for centralized gateway
        - ip link add vbdif10 type bridge
        - ip link add vbdif20 type bridge
        - ip link set vbdif10 up
        - ip link set vbdif20 up
        - ip link add vxlan10 type vxlan id 10 local 1.1.1.10 dstport 4789 nolearning
        - ip link add vxlan20 type vxlan id 20 local 1.1.1.10 dstport 4789 nolearning
        - ip link set vxlan10 up
        - ip link set vxlan20 up
        - ip link set vxlan10 master vbdif10
        - ip link set vxlan20 master vbdif20
        - ip address add 10.1.5.254/24 dev vbdif10
        - ip address add 10.1.8.254/24 dev vbdif20


    leaf1:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/g' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./startup-conf/leaf1.conf:/etc/frr/frr.conf
      exec:
        - touch /etc/frr/vtysh.conf
        - bash -c "echo 'PS1=\"[\\u@\\h]\\$ \"' > /root/.bashrc"

        - ip a a 1.1.1.11/24 dev eth1 
        - ip link add br10 type bridge
        - ip link add vxlan10 type vxlan id 10 local 1.1.1.11 dstport 4789 nolearning
        - ip link set br10 up
        - ip link set vxlan10 up
        - ip l s eth2 master br10
        - ip l s vxlan10 master br10

    leaf2:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/g' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./startup-conf/leaf2.conf:/etc/frr/frr.conf
      exec:
        - touch /etc/frr/vtysh.conf
        - bash -c "echo 'PS1=\"[\\u@\\h]\\$ \"' > /root/.bashrc"

        - ip a a 1.1.1.12/24 dev eth1
        - ip link add br20 type bridge
        - ip link add vxlan20 type vxlan id 20 local 1.1.1.12 dstport 4789 nolearning
        - ip link set br20 up
        - ip link set vxlan20 up
        - ip l s eth2 master br20
        - ip l s vxlan20 master br20

        - ip link add br10 type bridge
        - ip link add vxlan10 type vxlan id 10 local 1.1.1.12 dstport 4789 nolearning
        - ip link set br10 up
        - ip link set vxlan10 up
        - ip l s eth3 master br10
        - ip l s vxlan10 master br10

    vm1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.5.10/24 dev eth1
        - ip link set dev eth1 address 52:54:10:01:05:10
        - ip r r default via 10.1.5.254

    vm2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.8.10/24 dev eth1
        - ip link set dev eth1 address 52:54:10:01:08:10
        - ip r r default via 10.1.8.254

    vm3:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.5.11/24 dev eth1
        - ip link set dev eth1 address 52:54:10:01:05:11
        - ip r r default via 10.1.5.254

  links:
    - endpoints: ["spine1:eth1", "frrbr:xth1"]
    - endpoints: ["leaf1:eth1", "frrbr:xth2"]
    - endpoints: ["leaf2:eth1", "frrbr:xth3"]
    - endpoints: ["leaf1:eth2", "vm1:eth1"]
    - endpoints: ["leaf2:eth2", "vm2:eth1"]
    - endpoints: ["leaf2:eth3", "vm3:eth1"]
