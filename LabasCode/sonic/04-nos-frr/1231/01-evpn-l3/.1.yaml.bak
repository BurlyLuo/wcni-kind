name: l3
prefix: "l3"

topology:
  nodes:
    leaf1:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/leaf1.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        # # VTEP IP
        - ip addr add 100.64.0.1/32 dev lo
        # Leaf - spine leg
        - ip addr add 192.168.1.1/24 dev eth1
        # L3 VRF
        - ip link add red type vrf table 1100
        # Leaf host leg
        - ip link set eth2 master red
        - ip addr add 10.1.5.254/24 dev eth2
        - ip link set red up
        - ip link add br100 type bridge
        - ip link set br100 master red addrgenmode none
        - ip link set br100 addr aa:bb:cc:00:00:65
        - ip link add vni100 type vxlan local 100.64.0.1 dstport 4789 id 100 nolearning
        - ip link set vni100 master br100 addrgenmode none
        - ip link set vni100 type bridge_slave neigh_suppress on learning off
        - ip link set vni100 up
        - ip link set br100 up        

    leaf2:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/leaf2.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        - ip addr add 100.65.0.2/32 dev lo
        - ip addr add 192.168.1.3/24 dev eth1
        - ip link add red type vrf table 1100
        - ip addr add 10.1.8.254/24 dev eth2
        - ip link set eth2 master red
        - ip link set red up
        - ip link add br100 type bridge
        - ip link set br100 master red addrgenmode none
        - ip link set br100 addr aa:bb:cc:00:00:64
        - ip link add vni100 type vxlan local 100.65.0.2 dstport 4789 id 100 nolearning
        - ip link set vni100 master br100 addrgenmode none
        - ip link set vni100 type bridge_slave neigh_suppress on learning off
        - ip link set vni100 up
        - ip link set br100 up

    spine:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/spine.conf:/etc/frr/frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        - ip addr add 192.168.1.0/31 dev eth1
        - ip addr add 192.168.1.2/31 dev eth2

    vm1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.5.10/24 dev eth1
        - ip r r default via 10.1.5.254

    vm2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.8.10/24 dev eth1
        - ip r r default via 10.1.8.254

  links:
    - endpoints: ["leaf1:eth1", "spine:eth1"]
    - endpoints: ["leaf2:eth1", "spine:eth2"]
    - endpoints: ["vm1:eth1", "leaf1:eth2"]
    - endpoints: ["vm2:eth1", "leaf2:eth2"]
