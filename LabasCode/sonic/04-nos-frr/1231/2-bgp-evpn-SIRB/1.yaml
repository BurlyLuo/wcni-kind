name: evpn-cc
prefix: ""

topology:
  nodes:
    r1:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/frr.conf.r1:/etc/frr/frr.conf
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1
        - touch /etc/frr/vtysh.conf
        # ========== 关键: VTEP IP on loopback ==========
        - ip addr add 100.64.0.1/32 dev lo
        - ip link set lo up
        # Underlay网络 (eth1)
        - ip addr add 192.168.100.1/24 dev eth1
        - ip link set eth1 up
        # ========== 核心: VXLAN with static VNI ==========
        - ip link add vxlan100 type vxlan id 100 dstport 4789 local 100.64.0.1 nolearning
        - ip link add br100 type bridge
        - ip link set vxlan100 master br100
        - ip link set vxlan100 type bridge_slave neigh_suppress on learning off
        - ip link set br100 addr aa:bb:cc:00:00:01
        - ip link set br100 up
        - ip link set vxlan100 up
        # ========== VRF 配置 ==========
        - ip link add vrf-A type vrf table 100
        - ip link set up vrf-A
        # 将bridge加入VRF (关键!)
        - ip link set br100 master vrf-A
        # ========== L2VNI 配置 ==========
        - ip link add v5.5000 link br100 type vlan id 5
        - ip link set v5.5000 up
        - ip addr add 10.1.5.254/24 dev v5.5000
        - bridge vlan add vid 5 dev br100 self
        # ========== 物理接口配置 ==========
        - ip link set eth2 master br100
        - bridge vlan add dev eth2 vid 5 master pvid untagged
        # 为VLAN 5配置SVI
        - ip addr add 10.1.5.254/24 dev v5.5000

    r2:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/frr.conf.r2:/etc/frr/frr.conf
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1
        - touch /etc/frr/vtysh.conf
        # ========== 关键: VTEP IP on loopback ==========
        - ip addr add 100.64.0.2/32 dev lo
        - ip link set lo up
        # Underlay网络 (eth1)
        - ip addr add 192.168.100.2/24 dev eth1
        - ip link set eth1 up
        # ========== 核心: VXLAN with static VNI ==========
        - ip link add vxlan100 type vxlan id 100 dstport 4789 local 100.64.0.2 nolearning
        - ip link add br100 type bridge
        - ip link set vxlan100 master br100
        - ip link set vxlan100 type bridge_slave neigh_suppress on learning off
        - ip link set br100 addr aa:bb:cc:00:00:02
        - ip link set br100 up
        - ip link set vxlan100 up
        # ========== VRF 配置 ==========
        - ip link add vrf-A type vrf table 100
        - ip link set up vrf-A
        # 将bridge加入VRF (关键!)
        - ip link set br100 master vrf-A
        # ========== L2VNI 配置 ==========
        - ip link add v8.8000 link br100 type vlan id 8
        - ip link set v8.8000 up
        - ip addr add 10.1.8.254/24 dev v8.8000
        - bridge vlan add vid 8 dev br100 self
        # ========== 物理接口配置 ==========
        - ip link set eth3 master br100
        - bridge vlan add dev eth3 vid 8 master pvid untagged
        # 为VLAN 8配置SVI
        - ip addr add 10.1.8.254/24 dev v8.8000

    h1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.5 type vlan id 5
        - ip link set eth1.5 up
        - ip addr add 10.1.5.10/24 dev eth1.5
        - ip link set dev eth1.5 address 52:54:10:01:05:10
        - ip r r default via 10.1.5.254 dev eth1.5

    h2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip addr add 10.1.8.10/24 dev eth1
        - ip link set dev eth1 address 52:54:10:01:08:10
        - ip r r default via 10.1.8.254 dev eth1

  links:
    - endpoints: ["r1:eth1", "r2:eth1"]  # Underlay
    - endpoints: ["r1:eth2", "h1:eth1"]  # VLAN 5
    - endpoints: ["r2:eth3", "h2:eth1"]  # VLAN 8
