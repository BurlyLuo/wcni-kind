name: vs
prefix: ""
topology:
  nodes:
    sonic1:
      kind: sonic-vm
      image: 192.168.2.100:5000/sonic:latest

    sonic2:
      kind: sonic-vm
      image: 192.168.2.100:5000/sonic:latest

    vm1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
      - ip addr add 10.1.5.10/24 dev eth1
      - ip r r default via 10.1.5.1
      - ip l s eth1 add 00:00:10:01:05:10

    vm2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
      - ip addr add 10.1.5.11/24 dev eth1
      - ip r r default via 10.1.5.1
      - ip l s eth1 add 00:00:10:01:05:11

    vm3:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
      - ip addr add 10.1.8.10/24 dev eth1
      - ip r r default via 10.1.8.1
      - ip l s eth1 add 00:00:10:01:08:10

    vm4:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
      - ip addr add 10.1.8.11/24 dev eth1
      - ip r r default via 10.1.8.1
      - ip l s eth1 add 00:00:10:01:08:11

    gnmic:
      kind: linux
      image: ghcr.io/openconfig/gnmic:0.43.0
      binds:
        - gnmic/gnmic-config.yaml:/gnmic-config.yaml:ro
      cmd: --config /gnmic-config.yaml --debug --log --log-file /tmp/gnmic.log subscribe

    prometheus:
      kind: linux
      image: prom/prometheus:v3.7.3
      cmd: --config.file=/etc/prometheus/prometheus.yml
      binds:
        - prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      ports:
        - 9090:9090

    grafana:
      kind: linux
      image: grafana/grafana:12.0.2
      binds:
        - grafana/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml:ro
        - grafana/dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
        - grafana/dashboards:/var/lib/grafana/dashboards
      ports:
        - 3000:3000
      env:
        GF_SECURITY_ADMIN_PASSWORD: "admin"
        GF_USERS_ALLOW_SIGN_UP: "false"

  links:
    # vrnetlab uses the qemu user mode networking to connect the VM's (guest) management interface to the host.
    # https://containerlab.dev/manual/vrnetlab/#management-interface
    # https://wiki.qemu.org/Documentation/Networking#User_Networking_(SLIRP) 

    # sonic-vm container uses the following mapping for its linux interfaces:
    # eth0 - management interface connected to the containerlab management network
    # eth1 - first data (front-panel port) interface that is mapped to Ethernet0 port
    # eth2 - second data interface that is mapped to Ethernet4 port. Any new port will result in a "previous interface + 4" (Ethernet4) mapping.
    # When containerlab launches sonic-vs node, it will assign IPv4/6 address to the eth0 interface. Data interface eth1 mapped to Ethernet0 port.
    
    # sonic1:eth1 <> sonic2:eth1
    # Trunk vlan 5 8
    - endpoints: ["sonic1:eth1", "sonic2:eth1"]

    # sonic1:eth2 <> vm1:eth1
    # Access vlan 5
    - endpoints: ["sonic1:eth2", "vm1:eth1"]

    # sonic2:eth2 <> vm2:eth1
    # Access vlan 8
    - endpoints: ["sonic2:eth2", "vm2:eth1"]

    # sonic1:eth3 <> vm3:eth1
    # Access vlan 5
    - endpoints: ["sonic1:eth3", "vm3:eth1"]

    # sonic2:eth3 <> vm4:eth1
    # Access vlan 8
    - endpoints: ["sonic2:eth3", "vm4:eth1"]
