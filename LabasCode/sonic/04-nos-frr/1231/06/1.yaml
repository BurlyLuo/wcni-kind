name: evpn-tagged-vms
prefix: ""

topology:
  nodes:
    spine:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/spine.conf:/etc/frr/conf-frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1
        # spine to leaf1 and leaf2
        - ip addr add 192.168.1.0/31 dev eth1
        - ip addr add 192.168.1.2/31 dev eth2
        - ip link set eth1 up
        - ip link set eth2 up
        - /usr/lib/frr/frr-reload.py --reload /etc/frr/conf-frr.conf

    leaf1:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/leaf1.conf:/etc/frr/conf-frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        - modprobe 8021q
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1

        # add vtep ip
        - ip addr add 100.64.0.1/32 dev lo
         
        # leaf1 to spine
        - ip addr add 192.168.1.1/31 dev eth1
        - ip link set eth1 up
         
        # add vrf[spec vrf]
        - ip link add red type vrf table 1100
        - ip link set red up

        # vxlan100 -- L3VNI for VRF red
        - ip link add br100 type bridge
        - ip link set br100 up
        - ip link set br100 master red addrgenmode none
        - ip link add vxlan100 type vxlan local 100.64.0.1 dstport 4789 id 100 nolearning
        - ip link set vxlan100 master br100 addrgenmode none
        - ip link set vxlan100 type bridge_slave neigh_suppress on learning off
        - ip link set vxlan100 address 00:11:22:33:01:64
        - ip link set vxlan100 up


        # vxlan5 -- for L2VNI
        - ip link add br5 type bridge
        - ip link set br5 up
        - ip link add vxlan5 type vxlan local 100.64.0.1 dstport 4789 id 5000 nolearning
        - ip link set vxlan5 master br5 addrgenmode none
        - ip link set vxlan5 type bridge_slave neigh_suppress on learning off
        - ip link set vxlan5 up
        # L2VNI 5000 for 10.1.5.0/24 (VLAN 5)
        - bridge vlan add dev br5 vid 5 self
        - bridge vlan add dev vxlan5 vid 5
        - bridge vlan add dev vxlan5 vid 5 tunnel_info id 5000
        - ip link add vlan5 link br5 type vlan id 5
        - ip link set vlan5 master red
        - ip link set vlan5 address 00:11:22:33:01:05
        - ip addr add 10.1.5.254/24 dev vlan5
        - ip link set vlan5 up

        # L2VNI 8000 for 10.1.8.0/24 (VLAN 8)
        - ip link add br8 type bridge
        - ip link set br8 up
        - ip link add vxlan8 type vxlan local 100.64.0.1 dstport 4789 id 8000 nolearning
        - ip link set vxlan8 master br8 addrgenmode none
        - ip link set vxlan8 type bridge_slave neigh_suppress on learning off
        - ip link set vxlan8 up

        - bridge vlan add dev br8 vid 8 self
        - bridge vlan add dev vxlan8 vid 8
        - bridge vlan add dev vxlan8 vid 8 tunnel_info id 8000
        - ip link add vlan8 link br8 type vlan id 8
        - ip link set vlan8 master red
        - ip link set vlan8 address 00:11:22:33:01:08
        - ip addr add 10.1.8.254/24 dev vlan8
        - ip link set vlan8 up

        # Configure eth2 as TRUNK port for VM1
        - ip link set eth2 master br5
        # Configure eth3 as TRUNK port for VM3
        - ip link set eth3 master br8
        # Allow VLAN 5 on the trunk port [10.1.5.10/24]
        - bridge vlan add dev eth2 vid 5 master
        - ip link set eth2 up
        # Allow VLAN 8 on the trunk port [10.1.8.10/24]
        - bridge vlan add dev eth3 vid 8 master
        - ip link set eth3 up
       
        - /usr/lib/frr/frr-reload.py --reload /etc/frr/conf-frr.conf


    leaf2:
      kind: linux
      image: quay.io/weiluo/frrouting/frr:10.5.0
      cmd: sh -c "sed -i 's/bgpd=no/bgpd=yes/;s/zebra=no/zebra=yes/' /etc/frr/daemons && /usr/lib/frr/docker-start"
      binds:
        - /lib/modules:/lib/modules
        - ./frr/leaf2.conf:/etc/frr/conf-frr.conf
      exec:
        - bash -c "echo 'PS1=\"[\\\\u@\\\\h]\\\\$ \"' > /root/.bashrc"
        - touch /etc/frr/vtysh.conf
        - modprobe 8021q
        - sysctl -w net.ipv4.ip_forward=1
        - sysctl -w net.ipv6.conf.all.forwarding=1

        # add vtep ip 
        - ip addr add 100.65.0.2/32 dev lo

        # leaf2 to spine
        - ip addr add 192.168.1.3/31 dev eth1
        - ip link set eth1 up

        # add vrf[spec vrf] 
        - ip link add red type vrf table 1100
        - ip link set red up

        # vxlan 100 -- L3VNI for VRF red
        - ip link add br100 type bridge
        - ip link set br100 master red addrgenmode none
        - ip link add vxlan100 type vxlan local 100.65.0.2 dstport 4789 id 100 nolearning
        - ip link set vxlan100 master br100 addrgenmode none
        - ip link set vxlan100 type bridge_slave neigh_suppress on learning off
        - ip link set vxlan100 address 00:11:22:33:02:64
        - ip link set br100 up
        - ip link set vxlan100 up


        # SVD Setup: single bridge and single VXLAN device
        - ip link add br5 type bridge
        - ip link set br5 up
        - ip link add vxlan5 type vxlan local 100.65.0.2 dstport 4789 id 5000 nolearning
        - ip link set vxlan5 master br5 addrgenmode none
        - ip link set vxlan5 type bridge_slave neigh_suppress on learning off
        - ip link set vxlan5 up

        # L2VNI 5000 for 10.1.5.0/24 (VLAN 5)
        - bridge vlan add dev br5 vid 5 self
        - bridge vlan add dev vxlan5 vid 5
        - bridge vlan add dev vxlan5 vid 5 tunnel_info id 5000
        - ip link add vlan5 link br5 type vlan id 5
        - ip link set vlan5 master red
        - ip link set vlan5 address 00:11:22:33:02:05
        - ip addr add 10.1.5.254/24 dev vlan5
        - ip link set vlan5 up

        - ip link add br8 type bridge
        - ip link set br8 up
        - ip link add vxlan8 type vxlan local 100.65.0.2 dstport 4789 id 8000 nolearning
        - ip link set vxlan8 master br8 addrgenmode none
        - ip link set vxlan8 type bridge_slave neigh_suppress on learning off
        - ip link set vxlan8 up

        # L2VNI 8000 for 10.1.8.0/24 (VLAN 8)
        - bridge vlan add dev br8 vid 8 self
        - bridge vlan add dev vxlan8 vid 8
        - bridge vlan add dev vxlan8 vid 8 tunnel_info id 8000
        - ip link add vlan8 link br8 type vlan id 8
        - ip link set vlan8 master red
        - ip link set vlan8 address 00:11:22:33:02:08
        - ip addr add 10.1.8.254/24 dev vlan8
        - ip link set vlan8 up

        # Configure eth2 as TRUNK port for VM2
        - ip link set eth2 master br5
        # Configure eth3 as TRUNK port for VM4
        - ip link set eth3 master br8
        # Allow VLAN 5 on the trunk port [10.1.8.10/24]
        - bridge vlan add dev eth2 vid 5 master
        - ip link set eth2 up
        # Allow VLAN 8 on the trunk port [10.1.8.11/24]
        - bridge vlan add dev eth3 vid 8 master
        - ip link set eth3 up

        - /usr/lib/frr/frr-reload.py --reload /etc/frr/conf-frr.conf

    vm1:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.5 type vlan id 5
        - ip addr add 10.1.5.10/24 dev eth1.5
        - ip link set eth1.5 up
        - ip link set dev eth1 address 52:54:10:01:05:10
        - ip route r default via 10.1.5.254

    vm2:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.5 type vlan id 5
        - ip addr add 10.1.5.11/24 dev eth1.5
        - ip link set eth1.5 up
        - ip link set dev eth1 address 52:54:10:01:05:11
        - ip route r default via 10.1.5.254

    vm3:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.8 type vlan id 8
        - ip addr add 10.1.8.10/24 dev eth1.8
        - ip link set eth1.8 up
        - ip link set dev eth1 address 52:54:10:01:08:10
        - ip route r default via 10.1.8.254

    vm4:
      kind: linux
      image: 192.168.2.100:5000/nettool
      exec:
        - ip link add link eth1 name eth1.8 type vlan id 8
        - ip addr add 10.1.8.11/24 dev eth1.8
        - ip link set eth1.8 up
        - ip link set dev eth1 address 52:54:10:01:08:11
        - ip route r default via 10.1.8.254


  links:
    # spine <> leaf1
    - endpoints: ["spine:eth1", "leaf1:eth1"]
    # spine <> leaf2
    - endpoints: ["spine:eth2", "leaf2:eth1"]
   
    # leaf1 <> vm1 (10.1.5.10/24)
    - endpoints: ["leaf1:eth2", "vm1:eth1"]

    # leaf2 <> vm2 (10.1.5.11/24)
    - endpoints: ["leaf2:eth2", "vm2:eth1"]

    # leaf1 <> vm3 (10.1.8.10/24)
    - endpoints: ["leaf1:eth3", "vm3:eth1"]

    # leaf2 <> vm4 (10.1.8.11/24)
    - endpoints: ["leaf2:eth3", "vm4:eth1"]
