# 1. env info:
CONTAINER ID   IMAGE                                         COMMAND                  CREATED        STATUS        PORTS     NAMES
d1316d07b884   192.168.2.100:5000/xcni:http-keepalive-500s   "/sbin/tini -g -- /e…"   20 hours ago   Up 20 hours   80/tcp    clab-tcp-challenge-ack-server1
43212ab3c35d   192.168.2.100:5000/xcni                       "/sbin/tini -g -- /e…"   20 hours ago   Up 20 hours   80/tcp    clab-tcp-challenge-ack-gw1
530c6a738b98   192.168.2.100:5000/xcni:http-keepalive-500s   "/sbin/tini -g -- /e…"   20 hours ago   Up 20 hours   80/tcp    clab-tcp-challenge-ack-server2
# 2. 第一次正常访问：我加了一个iptables，会在gw1上drop掉FIN，ACK。所以在server2上一直是处在ESTABLISH(有一个前提是我nginx的keepalive timeout是500s)
[root@2204 ~]$ lo 43212ab3c35d bash 
[root@gw1 /]# tcpdump -pne -i eth1 
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
05:58:12.521440 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 74: 10.1.5.10.56924 > 10.1.8.10.http: Flags [S], seq 645583416, win 56760, options [mss 9460,sackOK,TS val 158155993 ecr 0,nop,wscale 7], length 0
05:58:12.521511 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 74: 10.1.8.10.http > 10.1.5.10.56924: Flags [S.], seq 121752502, ack 645583417, win 56688, options [mss 9460,sackOK,TS val 4183336279 ecr 158155993,nop,wscale 7], length 0
05:58:12.521530 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [.], ack 1, win 444, options [nop,nop,TS val 158155993 ecr 4183336279], length 0
05:58:12.521620 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 139: 10.1.5.10.56924 > 10.1.8.10.http: Flags [P.], seq 1:74, ack 1, win 444, options [nop,nop,TS val 158155993 ecr 4183336279], length 73: HTTP: GET / HTTP/1.1
05:58:12.521632 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 66: 10.1.8.10.http > 10.1.5.10.56924: Flags [.], ack 74, win 443, options [nop,nop,TS val 4183336279 ecr 158155993], length 0
05:58:12.521795 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 302: 10.1.8.10.http > 10.1.5.10.56924: Flags [P.], seq 1:237, ack 74, win 443, options [nop,nop,TS val 4183336280 ecr 158155993], length 236: HTTP: HTTP/1.1 200 OK
05:58:12.521842 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [.], ack 237, win 443, options [nop,nop,TS val 158155994 ecr 4183336280], length 0
05:58:12.521873 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 112: 10.1.8.10.http > 10.1.5.10.56924: Flags [P.], seq 237:283, ack 74, win 443, options [nop,nop,TS val 4183336280 ecr 158155994], length 46: HTTP
05:58:12.521879 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [.], ack 283, win 443, options [nop,nop,TS val 158155994 ecr 4183336280], length 0
05:58:12.521959 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158155994 ecr 4183336280], length 0
05:58:12.730111 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158156202 ecr 4183336280], length 0
05:58:12.937824 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158156410 ecr 4183336280], length 0
05:58:13.370661 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158156842 ecr 4183336280], length 0
05:58:14.202280 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158157674 ecr 4183336280], length 0
05:58:15.866501 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158159338 ecr 4183336280], length 0
05:58:17.722001 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype ARP (0x0806), length 42: Request who-has 10.1.5.10 tell 10.1.5.1, length 28
05:58:17.722052 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype ARP (0x0806), length 42: Request who-has 10.1.5.1 tell 10.1.5.10, length 28
05:58:17.722093 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype ARP (0x0806), length 42: Reply 10.1.5.1 is-at aa:c1:ab:ef:00:39, length 28
05:58:17.722082 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype ARP (0x0806), length 42: Reply 10.1.5.10 is-at aa:c1:ab:8b:49:c5, length 28
05:58:19.258719 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158162731 ecr 4183336280], length 0
05:58:25.914423 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158169386 ecr 4183336280], length 0



05:58:39.226075 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158182698 ecr 4183336280], length 0
05:58:44.346299 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype ARP (0x0806), length 42: Request who-has 10.1.5.1 tell 10.1.5.10, length 28
05:58:44.346352 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype ARP (0x0806), length 42: Reply 10.1.5.1 is-at aa:c1:ab:ef:00:39, length 28
05:59:06.618604 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158210090 ecr 4183336280], length 0
05:59:11.738185 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype ARP (0x0806), length 42: Request who-has 10.1.5.1 tell 10.1.5.10, length 28
05:59:11.738240 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype ARP (0x0806), length 42: Reply 10.1.5.1 is-at aa:c1:ab:ef:00:39, length 28


[root@server2 ~]# netstat -anp | grep 80
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      14/nginx: master pr 
tcp        0      0 10.1.8.10:80            10.1.5.10:56924         ESTABLISHED 15/nginx: worker pr 
[root@server2 ~]# 
[root@2204 4-Challenge-Ack]$ lo d1316d07b884 curl --local-port 56924 10.1.8.10  // 指定和上次使用相同的源端口。
PodName: server2 | PodIP: eth0 172.20.20.6/24
[root@2204 4-Challenge-Ack]$ 

# 3. 这个是使用和上次相同的端口的方式的抓包(在gw1上的eth1)
06:00:09.117535 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 74: 10.1.5.10.56924 > 10.1.8.10.http: Flags [S], seq 2467397363, win 56760, options [mss 9460,sackOK,TS val 158272589 ecr 0,nop,wscale 7], length 0
06:00:09.117582 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 66: 10.1.8.10.http > 10.1.5.10.56924: Flags [.], ack 74, win 443, options [nop,nop,TS val 4183452875 ecr 158155994], length 0
06:00:09.117594 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 54: 10.1.5.10.56924 > 10.1.8.10.http: Flags [R], seq 645583490, win 0, length 0   # 前边的过程是：SYN，然后server2 回一个ACKed的ACK，然后客户端发现不是自己上次SYN的期望的ACK，所以就RST掉了。但是后边疑问！？！
# 后边这里实际上是tcp的重传，且这个重传server2竟然回复了ASY+ACK。这里就比较奇怪了。
06:00:09.130368 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 74: 10.1.5.10.56924 > 10.1.8.10.http: Flags [S], seq 2467397363, win 56760, options [mss 9460,sackOK,TS val 158272602 ecr 0,nop,wscale 7], length 0
06:00:09.130446 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 74: 10.1.8.10.http > 10.1.5.10.56924: Flags [S.], seq 1943767064, ack 2467397364, win 56688, options [mss 9460,sackOK,TS val 4183452888 ecr 158272602,nop,wscale 7], length 0
06:00:09.130492 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [.], ack 1, win 444, options [nop,nop,TS val 158272602 ecr 4183452888], length 0
06:00:09.130652 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 139: 10.1.5.10.56924 > 10.1.8.10.http: Flags [P.], seq 1:74, ack 1, win 444, options [nop,nop,TS val 158272602 ecr 4183452888], length 73: HTTP: GET / HTTP/1.1
06:00:09.130736 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 66: 10.1.8.10.http > 10.1.5.10.56924: Flags [.], ack 74, win 443, options [nop,nop,TS val 4183452889 ecr 158272602], length 0
06:00:09.130847 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 302: 10.1.8.10.http > 10.1.5.10.56924: Flags [P.], seq 1:237, ack 74, win 443, options [nop,nop,TS val 4183452889 ecr 158272602], length 236: HTTP: HTTP/1.1 200 OK
06:00:09.130905 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [.], ack 237, win 443, options [nop,nop,TS val 158272603 ecr 4183452889], length 0
06:00:09.130935 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype IPv4 (0x0800), length 112: 10.1.8.10.http > 10.1.5.10.56924: Flags [P.], seq 237:283, ack 74, win 443, options [nop,nop,TS val 4183452889 ecr 158272603], length 46: HTTP
06:00:09.130940 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [.], ack 283, win 443, options [nop,nop,TS val 158272603 ecr 4183452889], length 0
06:00:09.131043 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158272603 ecr 4183452889], length 0
06:00:09.337938 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158272810 ecr 4183452889], length 0
06:00:09.546057 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158273018 ecr 4183452889], length 0
06:00:09.978515 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158273450 ecr 4183452889], length 0
06:00:10.809975 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158274282 ecr 4183452889], length 0
06:00:12.474521 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158275946 ecr 4183452889], length 0
06:00:14.202205 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype ARP (0x0806), length 42: Request who-has 10.1.5.10 tell 10.1.5.1, length 28
06:00:14.202257 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype ARP (0x0806), length 42: Request who-has 10.1.5.1 tell 10.1.5.10, length 28
06:00:14.202302 aa:c1:ab:ef:00:39 > aa:c1:ab:8b:49:c5, ethertype ARP (0x0806), length 42: Reply 10.1.5.1 is-at aa:c1:ab:ef:00:39, length 28
06:00:14.202291 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype ARP (0x0806), length 42: Reply 10.1.5.10 is-at aa:c1:ab:8b:49:c5, length 28
06:00:15.994543 aa:c1:ab:8b:49:c5 > aa:c1:ab:ef:00:39, ethertype IPv4 (0x0800), length 66: 10.1.5.10.56924 > 10.1.8.10.http: Flags [F.], seq 74, ack 283, win 443, options [nop,nop,TS val 158279466 ecr 4183452889], length 0
^C
50 packets captured
50 packets received by filter
0 packets dropped by kernel
[root@gw1 /]# 
